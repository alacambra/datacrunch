import MySQLdb
import Project
import Issue
import TimeEntry
from multiprocess import MultiQuery
from multiprocessing import Pipe


def do_it():
    db = MySQLdb.connect(
        host="marceli", # your host, usually localhost
        user="root", # your username
        passwd="root", # your password
        db="redmine") # name of the data base

    query_projects = "SELECT id, name, description, parent_id FROM projects"
    query_issues = "SELECT id, project_id, subject, description FROM issues"
    query_time_entries = '''SELECT te.id, te.project_id, user_id, issue_id, hours, comments, e.id, e.name
                        FROM time_entries as te inner join enumerations as e on te.activity_id = e.id'''

    projects = {}
    issues = {}
    time_entries = {}

    num_projects = get_number_of_rows(db, "projects")
    num_issues = get_number_of_rows(db, "issues")
    num_time_entries = get_number_of_rows(db, "time_entries")

    start = 0
    procs_projects = {}
    procs_issues = {}
    procs_time_entries = {}
    step = 1000

    run_query(query_projects, num_projects, step, procs_projects, db)
    object_generation(Project, projects, procs_projects)

    run_query(query_issues, num_issues, step, procs_issues, db)
    object_generation(Issue, issues, procs_issues)

    run_query(query_time_entries, num_time_entries, step, procs_time_entries, db)
    object_generation(TimeEntry, time_entries, procs_time_entries)


def run_query(q, final, step, procs_projects, db):

    start = 0
    for i in range(0, final + step, step):
        parent_conn, child_conn = Pipe()
        query = q + " limit " + str(start) + ", " + str(i)
        mq = MultiQuery.MultiQuery(query, db, child_conn)
        mq.start()
        resp = parent_conn.recv()
        procs_projects[mq] = resp
        start = i+1


def object_generation(clazz, container, procs_container):
    for proc in procs_container:
        proc.join()
        for p in procs_container[proc]:
            o = clazz.Object(p)
            container[o.id] = o
            str(o)


def get_number_of_rows(db, table_name):

    q = "SELECT count(*) as total FROM redmine." + table_name

    cursor = db.cursor()
    cursor.execute(q)
    n = cursor.fetchall()
    return n[0][0]

do_it()
















































